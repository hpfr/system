" -*- mode: vimrc -*-

" " don't persist interactive changes, this config is the source of truth
" " this is asynchronous and can potentially clobber following settings, so I
" " have it running on close with ZZ as a decent workaround
" sanitize tridactyllocal

" workaround to let hint -; be used with composite which uses semicolons as syntax
command hint_focus hint -;

" workaround race condition with inserting spaces in query
:unbind --mode=ex <Space>
:bind --mode=ex <A-Space> ex.insert_space_or_completion

colors midnight

set editorcmd $EDITOR

" make tab completion based on last visited to match the Firefox setting
set tabsort mru

" binds

bind J tabnext
bind K tabprev
bind gb fillcmdline bmarks
" I don't use the home command this overwrites
bind gh fillcmdline goto
" open links in new tabs in foreground rather than background
bind F hint -t
" handy multiwindow/multitasking binds
bind gd tabdetach
bind gD composite tabduplicate | tabdetach

" default bookmark storage to the Mobile Bookmarks folder since the default
" can't be changed on iOS. replace slashes in title to prevent tridactyl seeing
" them as path separators
command mobile_bmark_path js -d€ JS_ARGS[2] + ' /Mobile Bookmarks/' + (JS_ARGS[1] == 't' ? document.title.replace(new RegExp('/','g'), '／') : '')€
bind a composite get_current_url | mobile_bmark_path t | fillcmdline_notrail bmark

" toggle summary elements (and comment view for common link aggregators)
bind ;c hint -Jc summary,[class*='expand'],[class*='togg'],[aria-label='Collapse'],[class='comment_folder']

" tridactyl's qall kills windows sequentially, so the session won't restore correctly
bind ZZ composite sanitize tridactyllocal; jsb browser.runtime.sendNativeMessage('tridactyl',{cmd: 'ppid'}).then(x=>x.content) | exclaim_quiet kill

" Allow Ctrl-a to select all in the commandline
unbind --mode=ex <C-a>
" Allow Ctrl-c to copy in the commandline
unbind --mode=ex <C-c>

" site-specific

set searchurls.wk https://en.wikipedia.org/w/index.php?title=Special%3ASearch&search=
set searchurls.wb https://web.archive.org/web/
set searchurls.at https://archive.today/newest/
set searchurls.wba https://web.archive.org/web/*/
set searchurls.ata https://archive.today/%s*
set searchurls.def https://www.wordnik.com/words?myWord=
set searchurls.ol https://openlibrary.org/search?q=
set searchurls.hn https://hn.algolia.com/?q=
set searchurls.rd https://old.reddit.com/search?q=
set searchurls.yt https://www.youtube.com/results?search_query=
set searchurls.gen https://genius.com/search?q=
set searchurls.man https://www.mankier.com/?q=
set searchurls.nxo https://search.nixos.org/options?channel=unstable&query=
set searchurls.nxp https://search.nixos.org/packages?channel=unstable&query=
set searchurls.nxpr https://nixpk.gs/pr-tracker.html?pr=

" shortcuts to search for the current page's URL on link aggregators and the
" wayback machine
command canon_fallback js document.querySelector("link[rel='canonical']")?.getAttribute("href") || document.location.href
bind gsw composite canon_fallback | open wb
bind gsa composite canon_fallback | open at
bind gsh composite canon_fallback | tabopen hn
bind gsr composite canon_fallback | tabopen rd

seturl ^moz-extension://b2a9b85a-18a4-419b-9e51-22e80fca4c2a/static/docs/modules/_src_excmds_.html gotoselector h1,h2,h3

" Nixpkgs PR tracker straight from PR
bindurl ^https?://github.com/NixOS/nixpkgs/pull/\d gop composite js document.location.pathname.split('/')[4] | open nxpr

source $XDG_CONFIG_HOME/tridactyl/privaterc
